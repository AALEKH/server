DROP TABLE if exists t1;
CREATE TABLE t1 (a INT NOT NULL PRIMARY KEY AUTO_INCREMENT, b VARCHAR(256), KEY SECOND(a, b)) ENGINE=INNODB;
optimize table t1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	status	OK
INSERT INTO t1 VALUES (100000, REPEAT('A', 256));
INSERT INTO t1 VALUES (200000, REPEAT('A', 256));
INSERT INTO t1 VALUES (300000, REPEAT('A', 256));
INSERT INTO t1 VALUES (400000, REPEAT('A', 256));
optimize table t1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	status	OK
create procedure defragment()
begin
set @i = 0;
repeat
set @i = @i + 1;
optimize table t1;
select sleep(5);
until @i = 3 end repeat;
end //
select count(*) from t1;
count(*)
10004
select count(*) from t1 force index (second);
count(*)
10004
call defragment();
optimize table t1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	status	OK
select sleep(5);
sleep(5)
0
select count(*) from t1;
count(*)
7904
select count(*) from t1 force index (second);
count(*)
7904
SET @@global.innodb_defragment_n_pages = 3;
optimize table t1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	status	OK
select count(*) from t1;
count(*)
6904
select count(*) from t1 force index (second);
count(*)
6904
SET @@global.innodb_defragment_n_pages = 10;
optimize table t1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	status	OK
select count(*) from t1;
count(*)
6904
select count(*) from t1 force index (second);
count(*)
6904
DROP PROCEDURE defragment;
DROP TABLE t1;
